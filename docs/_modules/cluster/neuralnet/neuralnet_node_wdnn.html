<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cluster.neuralnet.neuralnet_node_wdnn &#8212; tensormsa 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="tensormsa 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cluster.neuralnet.neuralnet_node_wdnn</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">cluster.neuralnet.neuralnet_node</span> <span class="k">import</span> <span class="n">NeuralNetNode</span>
<span class="kn">from</span> <span class="nn">master.workflow.netconf.workflow_netconf_wdnn</span> <span class="k">import</span> <span class="n">WorkFlowNetConfWdnn</span>
<span class="kn">from</span> <span class="nn">master.workflow.data.workflow_data_frame</span> <span class="k">import</span> <span class="n">WorkFlowDataFrame</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">master.workflow.dataconf.workflow_dataconf_frame</span> <span class="k">import</span> <span class="n">WorkflowDataConfFrame</span>
<span class="kn">from</span> <span class="nn">cluster.common.neural_common_wdnn</span> <span class="k">import</span> <span class="n">NeuralCommonWdnn</span>
<span class="kn">from</span> <span class="nn">cluster.preprocess.pre_node_feed_fr2wdnn</span> <span class="k">import</span> <span class="n">PreNodeFeedFr2Wdnn</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">import</span>  <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">master.workflow.dataconf.workflow_dataconf_frame</span> <span class="k">import</span> <span class="n">WorkflowDataConfFrame</span> <span class="k">as</span> <span class="n">wf_data_conf</span>
<span class="kn">from</span> <span class="nn">master.workflow.data.workflow_data_frame</span> <span class="k">import</span> <span class="n">WorkFlowDataFrame</span> <span class="k">as</span> <span class="n">wf_data_node</span>
<span class="kn">from</span> <span class="nn">cluster.common.train_summary_info</span> <span class="k">import</span> <span class="n">TrainSummaryInfo</span>
<span class="c1">#from tensorflow.python.platform import tf_logging as logging</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">errno</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">cluster.preprocess.pre_node_feed_fr2wdnn</span> <span class="k">import</span> <span class="n">PreNodeFeedFr2Wdnn</span>
<span class="kn">from</span> <span class="nn">cluster.data.data_node_frame</span> <span class="k">import</span> <span class="n">DataNodeFrame</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">strftime</span>


<div class="viewcode-block" id="NeuralNetNodeWdnn"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn">[docs]</a><span class="k">class</span> <span class="nc">NeuralNetNodeWdnn</span><span class="p">(</span><span class="n">NeuralNetNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NeuralNetNodeWdnn.run"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf_data</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;NeuralNetNodeWdnn Run called&quot;</span><span class="p">)</span>
        <span class="c1">#return None</span>
        <span class="c1">#return None</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Wide &amp; Deep Network Training</span>
<span class="sd">                :param nnid : network id in tfmsacore_nninfo</span>
<span class="sd">                :return: acturacy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_node_parm</span><span class="p">(</span><span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;cls_pool&#39;</span><span class="p">]</span> <span class="c1"># Data feeder</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_batch</span><span class="p">(</span><span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">])</span> <span class="c1">#makebatch</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">before_train_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_before_make_batch</span><span class="p">(</span><span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>  <span class="c1">#before train batch</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_train_batch</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_train_before_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before_train_batch</span><span class="o">.</span><span class="n">nn_batch_ver_id</span><span class="p">)])</span>





            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_batch</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_train_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">])</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_train_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_batch</span><span class="p">])</span>


            <span class="c1">#model file copy</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_train_batch</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_train_before_path</span>
                <span class="n">dst</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">model_train_path</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">copy_all</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;model_path : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;hidden_layers : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;activation_function : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;batch_size : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;epoch : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;model_type : </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">))</span>


            <span class="n">data_conf_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_conf</span>

            <span class="c1"># make wide &amp; deep model</span>
            <span class="n">wdnn</span> <span class="o">=</span> <span class="n">NeuralCommonWdnn</span><span class="p">()</span>
            <span class="n">wdnn_model</span> <span class="o">=</span> <span class="n">wdnn</span><span class="o">.</span><span class="n">wdnn_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">),</span><span class="n">data_conf_info</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_train_path</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_demension</span><span class="p">)</span>

            <span class="c1">#feed</span>
            <span class="c1"># TODO file이 여러개면 어떻하지?</span>
            <span class="c1"># get prev node for load data</span>
            <span class="n">data_node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_backward_node_with_type</span><span class="p">(</span><span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span> <span class="s1">&#39;preprocess&#39;</span><span class="p">)</span>
            <span class="n">train_data_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool</span><span class="p">[</span><span class="n">data_node_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1">#get filename</span>
            <span class="n">file_queue</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">input_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#get file_name</span>

            <span class="c1">#file을 돌면서 최대 Row를 전부 들고 옴 tfrecord 총 record갯수 가져오는 방법필요</span>

            <span class="n">_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">_num_tfrecords_files</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#_batch_size = 2</span>

            <span class="c1">#multi Feeder modified</span>
            <span class="n">multi_read_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_read_flag</span>
            <span class="k">if</span> <span class="n">multi_read_flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">input_paths</span><span class="p">):</span>
                    <span class="n">_num_tfrecords_files</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_len</span><span class="p">(</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">python_io</span><span class="o">.</span><span class="n">tf_record_iterator</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>  <span class="c1"># get length of generators</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total loop &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_num_tfrecords_files</span><span class="o">/</span><span class="n">_batch_size</span><span class="p">))</span> <span class="p">)</span>

                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_num_tfrecords_files</span><span class="o">/</span><span class="n">_batch_size</span><span class="p">))):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of for loop &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">wdnn_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">input_fn</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">file_queue</span><span class="p">,</span><span class="n">_batch_size</span><span class="p">),</span> <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>

                <span class="n">results</span> <span class="o">=</span> <span class="n">wdnn_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                    <span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">input_fn</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">file_queue</span><span class="p">,</span> <span class="n">_batch_size</span><span class="p">),</span>
                    <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Todo H5</span>
                <span class="c1"># train per files in folder h5용</span>
                <span class="c1">#if multi_file flag = no이면 기본이 h5임</span>
                <span class="k">while</span><span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">has_next</span><span class="p">())</span> <span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;h5&quot;</span><span class="p">)</span>
                    <span class="c1">#파일이 하나 돌때마다</span>
                    <span class="c1">#for 배치사이즈와 파일의 총갯수를 가져다가 돌린다. -&gt; 마지막에 뭐가 있을지 구분한다.</span>
                     <span class="c1">#파일에 iter를 넣으면 배치만큼 가져오는 fn이 있음 그걸 __itemd에 넣고</span>
                    <span class="c1"># Input 펑션에서 multi를 vk판단해서 col와 ca를 구분한다.(이걸 배치마다 할 필요가 있나?)</span>
                    <span class="c1"># -&gt; 그러면서 피팅</span>
                    <span class="c1">#</span>
                    <span class="c1"># # Iteration is to improve for Model Accuracy</span>

                        <span class="c1"># Per Line in file</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">data_size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>

                        <span class="n">data_set</span> <span class="o">=</span> <span class="n">train_data_set</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">eval_data_Set</span> <span class="o">=</span> <span class="n">data_set</span>
                        <span class="c1">#input_fn2(self, mode, data_file, df, nnid, dataconf):</span>
                        <span class="n">wdnn_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                            <span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">input_fn2</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">file_queue</span><span class="p">,</span>
                                                                      <span class="n">data_set</span><span class="p">,</span><span class="n">data_conf_info</span><span class="p">),</span> <span class="n">steps</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
                        <span class="c1">#model fitting</span>
                        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;model fitting h5 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
                    <span class="c1"># #Select Next file</span>
                    <span class="n">train_data_set</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1">#results = wdnn_model.evaluate(</span>
                <span class="c1">#input_fn=lambda: train_data_set.input_fn2(tf.contrib.learn.ModeKeys.TRAIN, file_queue,</span>
                <span class="c1">#                                         eval_data_Set, data_conf_info), steps=200)</span>


            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;train data eval result : </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

            <span class="c1">#feature_map, target = train_data_set.input_fn(tf.contrib.learn.ModeKeys.TRAIN, file_queue, 128)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
            <span class="c1">#with tf.Session() as sess:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Wide and Deep Train Process] : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="NeuralNetNodeWdnn.generator_len"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.generator_len">[docs]</a>    <span class="k">def</span> <span class="nf">generator_len</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Help for Generator length promote util class(?)</span>
<span class="sd">                :param it : python generator</span>
<span class="sd">                :return: length of generatorDataNodeFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="p">))</span></div>

<div class="viewcode-block" id="NeuralNetNodeWdnn.read_hdf5_chunk"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.read_hdf5_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">read_hdf5_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="c1"># type4 partial read</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get_storer</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nrows</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span> <span class="o">//</span> <span class="n">chunksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span>
                                 <span class="n">start</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">,</span>
                                 <span class="n">stop</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">chunk</span></div>

<div class="viewcode-block" id="NeuralNetNodeWdnn.read_hdf5"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.read_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="n">store</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1">#df = store.get_storer(&#39;table1&#39;)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">)</span>
        <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="NeuralNetNodeWdnn.load_hdf5"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.load_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">load_hdf5</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load_hdf5</span>
<span class="sd">        :param data_path:</span>
<span class="sd">        :return:data_path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">store_filepath_name</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;adult.noth5&quot;</span>
        <span class="n">hdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">store_filepath_name</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_set_progress_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="NeuralNetNodeWdnn.predict2"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.predict2">[docs]</a>    <span class="k">def</span> <span class="nf">predict2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nn_id</span><span class="p">,</span> <span class="n">conf_data</span><span class="p">,</span> <span class="n">parm</span> <span class="o">=</span> <span class="p">{}):</span>

        <span class="c1"># model build</span>
        <span class="c1">#</span>
        <span class="c1"># self._init_node_parm(nn_id)</span>

        <span class="c1"># data_conf_info = WorkflowDataConfFrame(nn_id + &quot;_&quot; + ver + &quot;_&quot; + &quot;dataconf_node&quot;).data_conf</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span>
            <span class="n">netconf</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;net_conf&#39;</span><span class="p">]</span>
            <span class="n">dataconf</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;data_conf&#39;</span><span class="p">]</span>

            <span class="c1"># make wide &amp; deep model</span>
            <span class="n">wdnn</span> <span class="o">=</span> <span class="n">NeuralCommonWdnn</span><span class="p">()</span>
            <span class="c1"># wdnn_model = wdnn.wdnn_predict_build(&#39;wdnn&#39;, nn_id, netconf[&#39;hidden_layers&#39;], netconf[&#39;activation_function&#39;], &#39;&#39;, netconf[&#39;model_path&#39;], False)</span>

            <span class="n">wdnn_model</span> <span class="o">=</span> <span class="n">wdnn</span><span class="o">.</span><span class="n">wdnn_build</span><span class="p">(</span><span class="s1">&#39;wdnn&#39;</span><span class="p">,</span> <span class="n">nn_id</span><span class="p">,</span> <span class="n">netconf</span><span class="p">[</span><span class="s1">&#39;hidden_layers&#39;</span><span class="p">],</span><span class="n">netconf</span><span class="p">[</span><span class="s1">&#39;activation_function&#39;</span><span class="p">],</span><span class="n">dataconf</span><span class="p">[</span><span class="s1">&#39;data_conf&#39;</span><span class="p">],</span> <span class="n">netconf</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

            <span class="n">label_column</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataconf</span><span class="p">[</span><span class="s1">&#39;data_conf&#39;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># data -&gt; csv (pandas)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s1">&#39;/hoya_src_root/adultest.data&#39;</span><span class="p">),</span>
                             <span class="c1"># names=COLUMNS,</span>
                              <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>

            <span class="c1"># df[&#39;label&#39;] = (df[label_column].apply(lambda x: &quot;Y&quot; in x)).astype(int)</span>
            <span class="c1"># df[&#39;label&#39;] = (df[&#39;income_bracket&#39;].apply(lambda x: &#39;&gt;50K&#39; in x)).astype(int)</span>


            <span class="c1"># predict</span>
            <span class="c1">#    def input_fn(self, df, nnid, dataconf ):</span>
            <span class="n">predict_results</span> <span class="o">=</span> <span class="n">wdnn_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">wdnn</span><span class="o">.</span><span class="n">input_fn</span><span class="p">(</span> <span class="n">df</span><span class="p">,</span> <span class="n">nn_id</span><span class="p">,</span> <span class="n">dataconf</span><span class="p">[</span><span class="s1">&#39;data_conf&#39;</span><span class="p">]))</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predict_results</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_init_node_parm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init parameter from workflow_data_frame</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wf_net_conf</span> <span class="o">=</span> <span class="n">WorkFlowNetConfWdnn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">hidden_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">activation_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_demension</span> <span class="o">=</span> <span class="n">wf_net_conf</span><span class="o">.</span><span class="n">auto_demension</span>
        <span class="c1">#Todo 어떻게 꺼내는지 승우씨한테 물어볼것</span>
        <span class="n">_wf_data_conf</span> <span class="o">=</span> <span class="n">wf_data_conf</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;dataconf_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_conf</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">cell_feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_cell</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">cross_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cell_feature</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">extend_cell_feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_values</span> <span class="o">=</span> <span class="n">_wf_data_conf</span><span class="o">.</span><span class="n">label_values</span>

        <span class="n">_wf_data_node</span> <span class="o">=</span> <span class="n">wf_data_node</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_read_flag</span> <span class="o">=</span> <span class="n">_wf_data_node</span><span class="o">.</span><span class="n">multi_node_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_path</span> <span class="o">=</span> <span class="n">_wf_data_node</span><span class="o">.</span><span class="n">predict_path</span>


        <span class="c1">#if &#39;test&#39; in self.get_prev_node()[0].node_name:</span>
        <span class="c1">#    _wf_data_node = wf_data_node(key.split(not&#39;_&#39;)[0] + &#39;_&#39; + key.split(&#39;_&#39;)[1] + &#39;_&#39; + &#39;data_node&#39;)</span>
        <span class="c1">#    self.multi_read_flag = _wf_data_node.multi_node_flag</span>
        <span class="c1">#else:</span>
        <span class="c1">#_wf_data_node = wf_data_node(key.split(&#39;_&#39;)[0] + &#39;_&#39; + key.split(&#39;_&#39;)[1] + &#39;_&#39; + &#39;data_node&#39;)</span>
        <span class="c1">#self.multi_read_flag = _wf_data_node.multi_node_flag</span>


<div class="viewcode-block" id="NeuralNetNodeWdnn.eval"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">conf_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param node_id:</span>
<span class="sd">        :param parm:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;eval_starting ------&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_node_parm</span><span class="p">(</span><span class="n">node_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">node_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;netconf_node&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool_all</span> <span class="o">=</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;cls_pool&#39;</span><span class="p">]</span>  <span class="c1"># Data feeder</span>

        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_values</span><span class="p">,</span> <span class="s2">&quot;nn_id&quot;</span><span class="p">:</span><span class="n">conf_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nn_id&#39;</span><span class="p">),</span> <span class="s2">&quot;nn_wf_ver_id&quot;</span><span class="p">:</span><span class="n">conf_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_ver&#39;</span><span class="p">)}</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">TrainSummaryInfo</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eval_batch</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="c1">#print(train)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_eval_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">])</span>


        <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool_all</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">_k</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool</span> <span class="o">=</span> <span class="n">_v</span>

            <span class="k">if</span> <span class="s1">&#39;evaldata&#39;</span> <span class="ow">in</span> <span class="n">_k</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multi_node_flag</span> <span class="o">=</span> <span class="n">_v</span><span class="o">.</span><span class="n">multi_node_flag</span>

        <span class="c1">#conf_data[&#39;cls_pool&#39;].get(&#39;nn00001_1_pre_feed_fr2wdnn_test&#39;)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;model_path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hidden_layers : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;activation_function : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;batch_size : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model_type : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">))</span>

        <span class="c1"># data_store_path = WorkFlowDataFrame(conf_data[&#39;nn_id&#39;]+&quot;_&quot;+conf_data[&#39;wf_ver&#39;]+&quot;_&quot;+ &quot;data_node&quot;).step_store</span>
        <span class="n">data_conf_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_conf</span>

        <span class="c1"># make wide &amp; deep modelnot</span>
        <span class="n">wdnn</span> <span class="o">=</span> <span class="n">NeuralCommonWdnn</span><span class="p">()</span>
        <span class="n">wdnn_model</span> <span class="o">=</span> <span class="n">wdnn</span><span class="o">.</span><span class="n">wdnn_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">,</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">),</span> <span class="n">data_conf_info</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_eval_path</span><span class="p">))</span>

        <span class="c1"># feed</span>
        <span class="c1"># TODO file이 여러개면 어떻하지?</span>
        <span class="c1"># get prev node for load data</span>
        <span class="c1">#data_node_name = self._get_backward_node_with_type(conf_data[&#39;node_id&#39;], &#39;preprocess&#39;)</span>
        <span class="c1">#train_data_set = self.cls_pool[data_node_name[0]]  # get filename</span>
        <span class="n">train_data_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_pool</span>  <span class="c1"># get filename</span>
        <span class="n">file_queue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">input_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># get file_name</span>

        <span class="c1"># file을 돌면서 최대 Row를 전부 들고 옴 tfrecord 총 record갯수 가져오는 방법필요</span>

        <span class="n">_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">_num_tfrecords_files</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># multi Feeder modified</span>
        <span class="n">multi_read_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_read_flag</span>

        <span class="c1"># Todo H5</span>
        <span class="c1"># train per files in folder h5용</span>
        <span class="c1"># if multi_file flag = no이면 기본이 h5임</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">ori_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">pre_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">has_next</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;h5&quot;</span><span class="p">)</span>
                <span class="c1"># 파일이 하나 돌때마다</span>
                <span class="c1"># for 배치사이즈와 파일의 총갯수를 가져다가 돌린다. -&gt; 마지막에 뭐가 있을지 구분한다.</span>
                <span class="c1"># 파일에 iter를 넣으면 배치만큼 가져오는 fn이 있음 그걸 __itemd에 넣고</span>
                <span class="c1"># Input 펑션에서 multi를 vk판단해서 col와 ca를 구분한다.(이걸 배치마다 할 필요가 있나?)</span>
                <span class="c1"># -&gt; 그러면서 피팅</span>
                <span class="c1">#</span>
                <span class="c1"># # Iteration is to improve for Model Accuracy</span>

                <span class="c1"># Per Line in file</span>
                <span class="c1"># eval should be one line predict</span>
                <span class="c1">#self.batch_size = 2</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">data_size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>

                    <span class="n">data_set</span> <span class="o">=</span> <span class="n">train_data_set</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
                    <span class="c1">#if i == 0:</span>
                    <span class="c1">#eval_data_Set = data_set</span>
                    <span class="c1"># input_fn2(self, mode, data_file, df, nnid, dataconf):</span>
                    <span class="n">predict_value</span> <span class="o">=</span> <span class="n">wdnn_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                        <span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">train_data_set</span><span class="o">.</span><span class="n">input_fn2</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">file_queue</span><span class="p">,</span>
                                                                  <span class="n">data_set</span><span class="p">,</span> <span class="n">data_conf_info</span><span class="p">))</span>

                    <span class="n">data_set_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_set</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">predict_val_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_pv</span> <span class="k">for</span> <span class="n">_pv</span> <span class="ow">in</span> <span class="n">predict_value</span><span class="p">]</span>
                    <span class="n">predict_val_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_val_list</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">data_set_count</span> <span class="o">!=</span> <span class="n">predict_val_count</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;wdnn eval error check : dataframe count(</span><span class="si">{0}</span><span class="s2">) predict count(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_set_count</span><span class="p">,</span> <span class="n">predict_val_count</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;eval data validation check error : dataframe and predict count is different(neuralnet_node_wdnn.eval)&#39;</span><span class="p">)</span>

                    <span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_val_list</span> <span class="c1">#list(predict_value)</span>
                    <span class="c1">#_predict = list(predict_value)</span>
                    <span class="n">predict_y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">])</span>


                    <span class="n">ori_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">pre_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">]))</span>

                    <span class="c1"># model fitting</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ori_list</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_list</span><span class="p">))</span>
                    <span class="c1">#logging.error(&quot;wdnn eval ori list  : {0}&quot;.format(ori_list) )</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wdnn eval ori list  : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ori_list</span><span class="p">))</span> <span class="p">)</span>
                    <span class="c1">#logging.info(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;info&#39;))</span>
                    <span class="c1">#logging.debug(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;debug&#39;))</span>
                    <span class="c1">#logging.critical(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;critical&#39;))</span>
                    <span class="c1">#print(&quot;model fitting h5 &quot; + str(data_set))</span>
                <span class="c1"># #Select Next file</span>
                <span class="n">train_data_set</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

            <span class="c1">#TODO : 앞으로 옮기자</span>
            <span class="n">train</span><span class="o">.</span><span class="n">set_nn_batch_ver_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ori_list</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre_list</span>
                <span class="n">train</span><span class="o">.</span><span class="n">set_result_info</span><span class="p">(</span><span class="n">ori_list</span><span class="p">,</span> <span class="n">pre_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
                <span class="c1"># tfrecord는 여기서 Label을 변경한다. 나중에 꺼낼때 답이 없음 Tensor 객체로 추출되기 때문에 그러나 H5는 feeder에서 변환해주자</span>
                <span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
                <span class="n">le</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_values</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_ori</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ori_list</span><span class="p">):</span>
                    <span class="c1">#return_value = self.labels[np.argmax(model.predict(X_train))]</span>
                    <span class="n">train</span><span class="o">.</span><span class="n">set_result_info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_ori</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pre_list</span><span class="p">[</span><span class="n">_i</span><span class="p">])))</span>
            <span class="c1">#return self.batch</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eval error&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;eval end&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train</span></div>
        <span class="c1"># with tf.Session() as sess:</span>

<div class="viewcode-block" id="NeuralNetNodeWdnn.predict"><a class="viewcode-back" href="../../../cluster.neuralnet.html#cluster.neuralnet.neuralnet_node_wdnn.NeuralNetNodeWdnn.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span><span class="n">ver</span><span class="p">,</span> <span class="n">parm</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Wdnn predict </span>
<span class="sd">            batchlist info에서 active flag가 Y인 Model을 가져와서 예측을 함 </span>

<span class="sd">        Args:</span>
<span class="sd">          params: </span>
<span class="sd">            * node_id</span>
<span class="sd">            * conf_data</span>

<span class="sd">        Returns:</span>
<span class="sd">            none</span>

<span class="sd">        Raises:</span>

<span class="sd">        Example</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wdnn predict_start nnid : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_id</span><span class="p">))</span>
            <span class="n">_node_id</span> <span class="o">=</span> <span class="n">node_id</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ver</span><span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;netconf_node&quot;</span>

            <span class="n">_data_conf_id</span> <span class="o">=</span> <span class="n">node_id</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ver</span> <span class="o">+</span> <span class="s2">&quot;_dataconf_node&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_node_parm</span><span class="p">(</span><span class="n">_node_id</span><span class="p">)</span>
            <span class="c1">#self.cls_pool_all = conf_data[&#39;cls_pool&#39;]  # Data feeder</span>

            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_values</span><span class="p">,</span> <span class="s2">&quot;nn_id&quot;</span><span class="p">:</span><span class="n">node_id</span><span class="p">,</span> <span class="s2">&quot;nn_wf_ver_id&quot;</span><span class="p">:</span><span class="n">ver</span><span class="p">}</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">TrainSummaryInfo</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="c1">#print(config)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_batch</span><span class="p">(</span><span class="n">_node_id</span><span class="p">)</span>
            <span class="c1">#print(train)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_predict_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_node_flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">conf_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">conf_data</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_node_id</span>


            <span class="c1">#conf_data[&#39;cls_pool&#39;].get(&#39;nn00001_1_pre_feed_fr2wdnn_test&#39;)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model_path : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hidden_layers : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;activation_function : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;batch_size : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model_type : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">))</span>

            <span class="c1"># data_store_path = WorkFlowDataFrame(conf_data[&#39;nn_id&#39;]+&quot;_&quot;+conf_data[&#39;wf_ver&#39;]+&quot;_&quot;+ &quot;data_node&quot;).step_store</span>
            <span class="n">data_conf_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_conf</span>

            <span class="c1"># make wide &amp; deep model</span>
            <span class="n">wdnn</span> <span class="o">=</span> <span class="n">NeuralCommonWdnn</span><span class="p">()</span>
            <span class="n">wdnn_model</span> <span class="o">=</span> <span class="n">wdnn</span><span class="o">.</span><span class="n">wdnn_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">,</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation_function</span><span class="p">),</span> <span class="n">data_conf_info</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_predict_path</span><span class="p">))</span>

            <span class="c1"># feed</span>
            <span class="c1"># TODO file이 여러개면 어떻하지?</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="c1">#train_data_set = self.cls_pool  # get filename</span>
            <span class="c1">#file_queue = str(train_data_set.input_paths[0])  # get file_name</span>

            <span class="c1"># file을 돌면서 최대 Row를 전부 들고 옴 tfrecord 총 record갯수 가져오는 방법필요</span>

            <span class="n">_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">_num_tfrecords_files</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># multi Feeder modified</span>
            <span class="n">multi_read_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_read_flag</span>

            <span class="c1"># Todo H5</span>
            <span class="c1"># train per files in folder h5용</span>
            <span class="c1"># if multi_file flag = no이면 기본이 h5임</span>

            <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">ori_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">pre_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="c1">#self.batch_size = 5</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;h5&quot;</span><span class="p">)</span>
                <span class="c1">#feeder = PreNodeFeedFr2Wdnn().set_for_predict(_data_conf_id)</span>
                <span class="n">feeder</span> <span class="o">=</span> <span class="n">PreNodeFeedFr2Wdnn</span><span class="p">()</span>
                <span class="c1">#_data_conf_id</span>
                <span class="c1">#set_for_predict</span>
                <span class="n">feeder</span><span class="o">.</span><span class="n">set_for_predict</span><span class="p">(</span><span class="n">_data_conf_id</span><span class="p">)</span>
                <span class="n">data_node</span> <span class="o">=</span> <span class="n">DataNodeFrame</span><span class="p">()</span>
                <span class="n">train_data_set</span> <span class="o">=</span> <span class="n">data_node</span><span class="o">.</span><span class="n">load_csv_by_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1">#feeder.set_input_paths([self.predict_path + &quot;/&quot; + filename[1].name])</span>
                <span class="c1">#train_data_set = feeder</span>
                <span class="c1">#_size = train_data_set</span>
                <span class="c1"># 파일이 하나 돌때마다</span>
                <span class="c1"># for 배치사이즈와 파일의 총갯수를 가져다가 돌린다. -&gt; 마지막에 뭐가 있을지 구분한다.</span>
                <span class="c1"># 파일에 iter를 넣으면 배치만큼 가져오는 fn이 있음 그걸 __itemd에 넣고</span>
                <span class="c1"># Input 펑션에서 multi를 vk판단해서 col와 ca를 구분한다.(이걸 배치마다 할 필요가 있나?)</span>
                <span class="c1"># -&gt; 그러면서 피팅</span>
                <span class="c1">#</span>
                <span class="c1"># # Iteration is to improve for Model Accuracy</span>

                <span class="c1"># Per Line in file</span>
                <span class="c1"># eval should be one line predict</span>
                <span class="c1">#self.batch_size = 2</span>

                <span class="c1">#train_date를 어떻게 가져오냐가 문제</span>

                <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data_set</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>

                    <span class="n">data_set</span> <span class="o">=</span> <span class="n">train_data_set</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
                    <span class="c1">#if i == 0:</span>
                    <span class="c1">#eval_data_Set = data_set</span>
                    <span class="c1"># input_fn2(self, mode, data_file, df, nnid, dataconf):</span>
                    <span class="n">predict_value</span> <span class="o">=</span> <span class="n">wdnn_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                        <span class="n">input_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">feeder</span><span class="o">.</span><span class="n">input_fn2</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">ModeKeys</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                                                                  <span class="n">data_set</span><span class="p">,</span> <span class="n">data_conf_info</span><span class="p">))</span>

                    <span class="n">data_set_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_set</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">predict_val_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_pv</span> <span class="k">for</span> <span class="n">_pv</span> <span class="ow">in</span> <span class="n">predict_value</span><span class="p">]</span>
                    <span class="n">predict_val_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_val_list</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">data_set_count</span> <span class="o">!=</span> <span class="n">predict_val_count</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;wdnn eval error check : dataframe count(</span><span class="si">{0}</span><span class="s2">) predict count(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_set_count</span><span class="p">,</span> <span class="n">predict_val_count</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;eval data validation check error : dataframe and predict count is different(neuralnet_node_wdnn.eval)&#39;</span><span class="p">)</span>

                    <span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_val_list</span> <span class="c1">#list(predict_value)</span>
                    <span class="c1">#_predict = list(predict_value)</span>
                    <span class="n">predict_y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">])</span>
                    <span class="c1">#pd.concat(result_df, data_set)</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
                    <span class="n">ori_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">pre_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data_set</span><span class="p">[</span><span class="s1">&#39;predict_label&#39;</span><span class="p">]))</span>

                    <span class="c1"># model fitting</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ori_list</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_list</span><span class="p">))</span>
                    <span class="c1">#logging.error(&quot;wdnn eval ori list  : {0}&quot;.format(ori_list) )</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wdnn eval ori list  : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ori_list</span><span class="p">))</span> <span class="p">)</span>
                    <span class="c1">#logging.info(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;info&#39;))</span>
                    <span class="c1">#logging.debug(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;debug&#39;))</span>
                    <span class="c1">#logging.critical(&quot;wdnn eval ori list  : {0}&quot;.format(&#39;critical&#39;))</span>
                    <span class="c1">#print(&quot;model fitting h5 &quot; + str(data_set))</span>
                <span class="c1"># #Select Next file</span>


                <span class="c1">#train_data_set.next()</span>

            <span class="n">predict_result_dir</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_and_exist_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;result&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">predict_result_filename</span> <span class="o">=</span> <span class="n">predict_result_dir</span> <span class="o">+</span> <span class="s2">&quot;result_&quot;</span> <span class="o">+</span> <span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%H:%M:%S&quot;</span><span class="p">,</span>
                                                                                <span class="n">gmtime</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
            <span class="n">result_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">predict_result_filename</span><span class="p">)</span>
            <span class="c1">#os.remove(self.predict_path + &quot;/&quot; + filename[1].name)</span>




            <span class="c1"># #TODO : 앞으로 옮기자</span>
            <span class="c1"># train.set_nn_batch_ver_id(self.batch)</span>
            <span class="c1"># if self.model_type == &quot;regression&quot;:</span>
            <span class="c1">#     results[&#39;ori&#39;] = ori_list</span>
            <span class="c1">#     results[&#39;pre&#39;] = pre_list</span>
            <span class="c1">#     train.set_result_info(ori_list, pre_list)</span>
            <span class="c1">#</span>
            <span class="c1"># if self.model_type == &quot;category&quot;:</span>
            <span class="c1">#     # tfrecord는 여기서 Label을 변경한다. 나중에 꺼낼때 답이 없음 Tensor 객체로 추출되기 때문에 그러나 H5는 feeder에서 변환해주자</span>
            <span class="c1">#     le = LabelEncoder()</span>
            <span class="c1">#     le.fit(self.label_values)</span>
            <span class="c1">#</span>
            <span class="c1">#     for _i, _ori in enumerate(ori_list):</span>
            <span class="c1">#         #return_value = self.labels[np.argmax(model.predict(X_train))]</span>
            <span class="c1">#         train.set_result_info(str(_ori), str(le.inverse_transform(pre_list[_i])))</span>
            <span class="c1">#return self.batch</span>


            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;eval end&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">train</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wdnn predict error </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div></div>

    <span class="c1"># with tf.Session() as sess:</span>




</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, seungwookim.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>